# Automatically generated with ❤️ by django-sage-painless
version: "{{docker_config.get('compose_version', '3.8')}}"

services:
  web:
    container_name: web
    build: .
    {% if gunicorn %}
    command: bash -c "python manage.py makemigrations && python manage.py migrate && gunicorn -c gunicorn-conf.py {{kernel}}.wsgi:application"
    {%elif uwsgi%}
    command: bash -c "python manage.py makemigrations && python manage.py migrate && uwsgi --ini uwsgi.ini"
    {%else%}
    command: bash -c "python manage.py makemigrations && python manage.py migrate && python manage.py runserver 0.0.0.0:8000"
    {%endif%}
    volumes:
      - .:/code
    ports:
      - 8000:8000
    hostname: web
    {% if docker_config.get('redis') %}
    environment:
      - REDIS_URL={{docker_config.get('redis_url', 'redis://redis:6379/')}}
    {% endif %}
    env_file:
      - ./.env.prod
    depends_on:
      - db
      {% if docker_config.get('redis') %}
      - redis
      {% endif %}
      {% if docker_config.get('rabbitmq') %}
      - rabbitmq
      {% endif %}
  db:
    container_name: db
    image: {{docker_config.get('db_image', 'postgres')}}
    hostname: db
    restart: on-failure
    environment:
      - POSTGRES_DB={{docker_config.get('db_name')}}
      - POSTGRES_USER={{docker_config.get('db_user')}}
      - POSTGRES_PASSWORD={{docker_config.get('db_pass')}}
  {% if docker_config.get('redis') %}
  redis:
    container_name: redis
    image: redis:alpine
  {% endif %}
  {% if docker_config.get('rabbitmq') %}
  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3-management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER={{docker_config.get('rabbitmq_user')}}
      - RABBITMQ_DEFAULT_PASS={{docker_config.get('rabbitmq_pass')}}
      - RABBITMQ_DEFAULT_VHOST={{docker_config.get('rabbitmq_vhost', '/')}}
  {% endif %}
  {%if nginx%}
  nginx:
      build: .
      ports:
        - 1337:80
      depends_on:
        - web
  {%endif%}